{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>FMS | {% block title %}{% endblock %}</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{
            --green:#228B22;
            --yellow:#FFD700;
            --light:#f5f7f8;
            --dark:#243142;
            --muted:#6c757d;

            --sidebar-bg:#0f2c19;
            --sidebar-text:#dfefdf;
            --sidebar-hover:rgba(255,255,255,.08);

            --radius:12px;
            --trans:.22s ease;
        }

        body{
            background:var(--light);
            font-family:'Ubuntu', sans-serif;
        }

        /* LAYOUT */
        #wrapper{
            display:flex;
            min-height:100vh;
        }

        /* SIDEBAR */
        #sidebar-wrapper{
            width:260px;
            background:var(--sidebar-bg);
            padding:1.4rem 1rem;
            color:var(--sidebar-text);
            box-shadow:4px 0 14px rgba(0,0,0,.08);
        }

        .sidebar-heading{
            font-size:1.4rem;
            font-weight:700;
            color:white;
            text-align:center;
            margin-bottom:1.5rem;
        }

        .list-group-item-menu{
            display:flex;
            align-items:center;
            padding:.75rem .9rem;
            border-radius:var(--radius);
            color:var(--sidebar-text);
            margin-bottom:.4rem;
            text-decoration:none;
            transition:var(--trans);
            gap:.9rem;
            font-size:.98rem;
        }

        .list-group-item-menu:hover{
            background:var(--sidebar-hover);
            color:white;
            transform:translateX(4px);
        }

        .list-group-item-menu.active{
            background:rgba(255,255,255,.15);
            color:white;
            border-left:5px solid var(--yellow);
            font-weight:600;
        }

        .collapse-sub-menu a{
            display:block;
            padding:.55rem 1.4rem;
            color:#e7f4e7;
            border-radius:8px;
            margin-bottom:4px;
            text-decoration:none;
        }

        .collapse-sub-menu a.active{
            background:rgba(255,255,255,.2);
            border-left:5px solid var(--yellow);
        }

        /* TOP NAV */
        .top-navbar{
            background:white;
            padding:1rem 1.5rem;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:1px solid rgba(0,0,0,.075);
            box-shadow:0 2px 8px rgba(0,0,0,.04);
        }

        .avatar{
            width:40px;
            height:40px;
            border-radius:10px;
            background:linear-gradient(180deg,#e4ffe4,#ccf3cc);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            color:var(--green);
        }

        /* CONTENT */
        #page-content-wrapper{
            flex:1;
            display:flex;
            flex-direction:column;
        }

        .content-area{
            padding:2rem;
        }
    </style>

</head>
<body>

<div id="wrapper">

    {% if user.is_authenticated %}

    <!-- SIDEBAR -->
    <div id="sidebar-wrapper">

        <div class="sidebar-heading">
            <i class="fas fa-truck-moving text-warning"></i> FMS
        </div>

        <!-- MENU PRINCIPAL -->
        <div>

            <!-- Liens communs à tous les utilisateurs connectés -->
            <a href="{% url 'dashboard' %}"
               class="list-group-item-menu {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <i class="fas fa-chart-line"></i> Tableau de bord
            </a>

            <a href="{% url 'alertes_echeances' %}"
               class="list-group-item-menu {% if request.resolver_match.url_name == 'alertes_echeances' %}active{% endif %}">
                <i class="fas fa-bell"></i>Alertes d’échéances
            </a>


            {# ===================================================== #}
            {#  ESPACE GESTIONNAIRE / ADMIN : modules métier        #}
            {# ===================================================== #}
            {% if user.is_superuser or user.role.nom == 'Gestionnaire Flotte' or user.role.nom == 'Administrateur Système' %}

            <!-- Gestion de la flotte -->
            <a class="list-group-item-menu {% if 'vehicule' in request.path or 'conducteur' in request.path or 'affectation' in request.path %}active{% endif %}"
               href="#flotteSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-truck-moving"></i> Gestion de la flotte
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="flotteSubMenu"
                 class="collapse collapse-sub-menu {% if 'vehicule' in request.path or 'conducteur' in request.path or 'affectation' in request.path %}show{% endif %}">
                <a href="{% url 'vehicule_list' %}"
                   class="{% if 'vehicule' in request.path %}active{% endif %}">
                    Véhicules
                </a>
                <a href="{% url 'conducteur_list' %}"
                   class="{% if 'conducteur' in request.path %}active{% endif %}">
                    Conducteurs
                </a>
                <a href="{% url 'affectation_list' %}"
                   class="{% if 'affectation' in request.path %}active{% endif %}">
                    Affectations
                </a>
            </div>

            <!-- Documents & conformité : Assurances / Taxes / Visites -->
            <a class="list-group-item-menu {% if 'assurance' in request.path or 'taxe' in request.path or 'visite' in request.path %}active{% endif %}"
               href="#docsSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-file-invoice"></i> Documents & conformité
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="docsSubMenu"
                 class="collapse collapse-sub-menu {% if 'assurance' in request.path or 'taxe' in request.path or 'visite' in request.path %}show{% endif %}">
                <a href="{% url 'assurance_list' %}"
                   class="{% if 'assurance' in request.path %}active{% endif %}">
                    Assurances
                </a>
                <a href="{% url 'taxe_list' %}"
                   class="{% if 'taxe' in request.path %}active{% endif %}">
                    Taxes de circulation
                </a>
                <a href="{% url 'visite_list' %}"
                   class="{% if 'visite' in request.path %}active{% endif %}">
                    Visites techniques
                </a>
            </div>

            <!-- Maintenance : Entretiens + Anomalies -->
            <a class="list-group-item-menu {% if 'entretien' in request.path or 'anomalie' in request.path %}active{% endif %}"
               href="#maintenanceSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-wrench"></i> Maintenance
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="maintenanceSubMenu"
                 class="collapse collapse-sub-menu {% if 'entretien' in request.path or 'anomalie' in request.path %}show{% endif %}">
                <a href="{% url 'entretien_list' %}"
                   class="{% if 'entretien' in request.path %}active{% endif %}">
                    Entretiens
                </a>
                <a href="{% url 'anomalie_list' %}"
                   class="{% if 'anomalie' in request.path %}active{% endif %}">
                    Anomalies
                </a>
            </div>

            <!-- Carburant -->
            <a class="list-group-item-menu {% if 'ravitaillement' in request.path %}active{% endif %}"
               href="#carburantSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-gas-pump"></i> Carburant
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="carburantSubMenu"
                 class="collapse collapse-sub-menu {% if 'ravitaillement' in request.path %}show{% endif %}">
                <a href="{% url 'ravitaillement_list' %}"
                   class="{% if 'ravitaillement' in request.path %}active{% endif %}">
                    Ravitaillements
                </a>
            </div>

            <!-- Fournisseurs -->
            <a class="list-group-item-menu {% if 'fournisseur' in request.path or 'piece' in request.path %}active{% endif %}"
               href="#fournisseurSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-handshake"></i> Fournisseurs
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="fournisseurSubMenu"
                 class="collapse collapse-sub-menu {% if 'fournisseur' in request.path or 'piece' in request.path %}show{% endif %}">
                <a href="{% url 'fournisseur_list' %}"
                   class="{% if 'fournisseur' in request.path %}active{% endif %}">
                    Fournisseurs
                </a>
                <a href="{% url 'piece_list' %}"
                   class="{% if 'piece' in request.path %}active{% endif %}">
                    Pièces & consommables
                </a>
            </div>

            <!-- Rapports & Statistiques -->
            <a class="list-group-item-menu {% if request.resolver_match.url_name == 'rapports_tco' or request.resolver_match.url_name == 'rapports_performance' %}active{% endif %}"
               href="#reportSubMenu" data-bs-toggle="collapse">
                <i class="fas fa-chart-pie"></i> Rapports & Statistiques
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>

            <div id="reportSubMenu"
                 class="collapse collapse-sub-menu {% if request.resolver_match.url_name == 'rapports_tco' or request.resolver_match.url_name == 'rapports_performance' %}show{% endif %}">
                <a href="{% url 'rapports_tco' %}"
                   class="{% if request.resolver_match.url_name == 'rapports_tco' %}active{% endif %}">
                    Coûts & TCO
                </a>
                <a href="{% url 'rapports_performance' %}"
                   class="{% if request.resolver_match.url_name == 'rapports_performance' %}active{% endif %}">
                    Performance flotte
                </a>
                <a href="{% url 'simulation_trajet' %}"
                   class="{% if request.resolver_match.url_name == 'simulation_trajet' %}active{% endif %}">
                    Simulation de trajet
                </a>

            </div>

            {% endif %}

            {# ================================================ #}
            {#  ESPACE ADMIN : gestion des utilisateurs         #}
            {# ================================================ #}
            {% if user.is_superuser or user.role.nom == 'Administrateur Système' %}
            <div class="text-light small mt-3 mb-2">Administration</div>

            <a href="{% url 'user_create' %}"
               class="list-group-item-menu {% if request.resolver_match.url_name == 'user_create' %}active{% endif %}">
                <i class="fas fa-users-cog"></i> Créer un utilisateur
            </a>
            {% endif %}

            {# ================================================ #}
            {#  ESPACE CHAUFFEUR / OPÉRATEUR                   #}
            {# ================================================ #}
            {% if user.role.nom == 'Chauffeur/Opérateur' and not user.is_superuser and user.role.nom != 'Gestionnaire Flotte' %}
            <div class="text-light small mt-3 mb-2">Espace opérateur</div>

            <a href="{% url 'anomalie_list' %}"
               class="list-group-item-menu {% if request.resolver_match.url_name == 'anomalie_list' %}active{% endif %}">
                <i class="fas fa-exclamation-triangle"></i> Mes anomalies
            </a>

            <a href="{% url 'anomalie_create' %}"
               class="list-group-item-menu {% if request.resolver_match.url_name == 'anomalie_create' %}active{% endif %}">
                <i class="fas fa-plus-circle"></i> Signaler une anomalie
            </a>
            {% endif %}

        </div>
    </div>

    {% endif %}

    <!-- CONTENT -->
    <div id="page-content-wrapper">

        <!-- TOPBAR -->
        <nav class="top-navbar">
            <div>
                <h5 class="mb-0">{% block page_title %}{% endblock %}</h5>
                <small class="text-muted">{{ user.role.nom|default:"Invité" }}</small>
            </div>

            {% if user.is_authenticated %}
            <div class="d-flex align-items-center gap-3">
                <div class="avatar">{{ user.username|slice:":1"|upper }}</div>
                <form action="{% url 'logout' %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" style="
                        background: none;
                        border: none;
                        padding: 0;
                        cursor: pointer;
                        color: red;
                        text-decoration: red;
                    ">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </form>
            </div>
            {% endif %}
        </nav>

        <!-- PAGE CONTENT -->
        <div class="content-area">
            {% block content %}{% endblock %}
        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
